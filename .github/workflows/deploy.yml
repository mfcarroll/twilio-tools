name: Deploy to Twilio

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Twilio CLI and Plugin
        run: |
          npm install -g twilio-cli
          twilio plugins:install @twilio-labs/plugin-serverless

      - name: Install Dependencies
        run: npm ci

      - name: Create .env file
        run: |
          touch .env
          echo "ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}" >> .env
          echo "AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}" >> .env
          echo "ROUTER_CONFIG='${{ vars.ROUTER_CONFIG }}'" >> .env
          echo "SMS_TOOL_USERNAME=${{ secrets.SMS_TOOL_USERNAME }}" >> .env
          echo "SMS_TOOL_PASSWORD=${{ secrets.SMS_TOOL_PASSWORD }}" >> .env
          # Note: TWILIO_NUMBER is optional if you aren't using it in code, 
          # but you can add it here if you kept it.

      - name: Deploy to Twilio
        # These env vars authenticate the CLI itself
        env:
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_API_KEY: ${{ secrets.TWILIO_API_KEY }}
          TWILIO_API_SECRET: ${{ secrets.TWILIO_API_SECRET }}
        # Now the command is simple and clean
        run: twilio serverless:deploy --force
